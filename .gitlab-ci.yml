# =============================================================================
# GitLab CI/CD Pipeline for TutorHub
# =============================================================================
#
# Features:
# - Parallel lint + test execution (non-blocking lints)
# - Auto-build and push on main/develop branches
# - Docker Hub registry integration
# - Cached image pulls for faster execution
#
# Required CI/CD Variables:
#   DOCKERHUB_TOKEN: Docker Hub access token
#
# =============================================================================

stages:
  - validate      # Lint + Test in parallel (non-blocking lints)
  - build         # Build artifacts
  - docker        # Build + Push Docker images

# =============================================================================
# Global Configuration
# =============================================================================

variables:
  # Harbor Registry (proxy for Docker Hub images)
  HARBOR_REGISTRY: harbor.in.lazarev.cloud

  # Performance
  FF_USE_FASTZIP: "true"
  CACHE_COMPRESSION_LEVEL: "fast"
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  NPM_CONFIG_CACHE: "$CI_PROJECT_DIR/.cache/npm"

  # Database for tests
  POSTGRES_HOST: postgres
  POSTGRES_PORT: "5432"
  POSTGRES_DB: test_db
  POSTGRES_USER: test_user
  POSTGRES_PASSWORD: test_password
  REDIS_HOST: redis
  REDIS_PORT: "6379"

  # Docker Hub images
  DOCKERHUB_USER: va2mne
  FRONTEND_IMAGE: va2mne/tutorhub-frontend
  BACKEND_IMAGE: va2mne/tutorhub-backend

# Default settings
default:
  tags:
    - docker
    - linux
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

# =============================================================================
# Cache Templates
# =============================================================================

.node_cache: &node_cache
  cache:
    key:
      files:
        - frontend/package-lock.json
    paths:
      - frontend/node_modules/
      - .cache/npm/
    policy: pull-push

.pip_cache: &pip_cache
  cache:
    key:
      files:
        - backend/requirements.txt
    paths:
      - .cache/pip/
    policy: pull-push

# =============================================================================
# Docker Build Template
# =============================================================================

.docker-build:
  stage: docker
  image: ${HARBOR_REGISTRY}/proxy/docker:24-dind
  services:
    - name: ${HARBOR_REGISTRY}/proxy/docker:24-dind
      alias: docker
      command: ["--tls=false"]
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - |
      echo "Waiting for Docker daemon..."
      for i in $(seq 1 30); do
        docker info >/dev/null 2>&1 && break
        sleep 2
      done
    - echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USER" --password-stdin
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop"'
  interruptible: false
  timeout: 30 minutes

# =============================================================================
# Stage: Validate (Lint + Test in parallel)
# =============================================================================

# --- Linting Jobs (all allow_failure: true) ---

lint:frontend:
  stage: validate
  image: ${HARBOR_REGISTRY}/proxy/node:20-alpine
  needs: []
  <<: *node_cache
  script:
    - cd frontend
    - npm ci --prefer-offline --no-audit
    - npm run lint -- --max-warnings 0 || true
    - npx prettier --check "**/*.{ts,tsx,js,jsx}" || true
  allow_failure: true
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH'
  timeout: 10 minutes

lint:backend:ruff:
  stage: validate
  image: ${HARBOR_REGISTRY}/proxy/python:3.12-slim
  needs: []
  script:
    - pip install --quiet ruff
    - cd backend && ruff check . || true
    - cd backend && ruff format --check . || true
  allow_failure: true
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH'
  timeout: 5 minutes

lint:security:
  stage: validate
  image: ${HARBOR_REGISTRY}/proxy/python:3.12-slim
  needs: []
  script:
    - pip install --quiet bandit pip-audit
    - cd backend && bandit -r . -f txt -x ./tests || true
    - cd backend && pip install -q -r requirements.txt && pip-audit || true
  allow_failure: true
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH'
  timeout: 10 minutes

lint:npm-audit:
  stage: validate
  image: ${HARBOR_REGISTRY}/proxy/node:20-alpine
  needs: []
  script:
    - cd frontend && npm audit --audit-level=high || true
  allow_failure: true
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH'
  timeout: 5 minutes

# --- Test Jobs (non-blocking) ---

test:frontend:
  stage: validate
  image: ${HARBOR_REGISTRY}/proxy/node:20-alpine
  needs: []
  <<: *node_cache
  script:
    - cd frontend
    - npm ci --prefer-offline --no-audit
    - npm test -- --coverage --watchAll=false --passWithNoTests
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    reports:
      junit: frontend/junit.xml
    when: always
    expire_in: 7 days
  allow_failure: true
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH'
  timeout: 15 minutes

test:backend:
  stage: validate
  image: ${HARBOR_REGISTRY}/proxy/python:3.12-slim
  needs: []
  <<: *pip_cache
  services:
    - name: ${HARBOR_REGISTRY}/proxy/postgres:16-alpine
      alias: postgres
    - name: ${HARBOR_REGISTRY}/proxy/redis:7-alpine
      alias: redis
  variables:
    DATABASE_URL: "postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_DB}"
    REDIS_URL: "redis://${REDIS_HOST}:${REDIS_PORT}/0"
    TESTING: "true"
    SECRET_KEY: "test-secret-key-for-ci-pipeline-32chars"
  before_script:
    - apt-get update && apt-get install -y --no-install-recommends postgresql-client
    - |
      echo "Waiting for PostgreSQL..."
      for i in $(seq 1 30); do
        pg_isready -h postgres -U $POSTGRES_USER && break
        sleep 2
      done
    - cd backend
    - pip install --quiet -r requirements.txt -r requirements-dev.txt
  script:
    - pytest tests/ -v --tb=short -x --cov=. --cov-report=term-missing --junitxml=junit.xml --timeout=120
  coverage: '/TOTAL.*\s+(\d+%)/'
  artifacts:
    reports:
      junit: backend/junit.xml
    when: always
    expire_in: 7 days
  allow_failure: true
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH'
  timeout: 20 minutes

# =============================================================================
# Stage: Build
# =============================================================================

build:frontend:
  stage: build
  image: ${HARBOR_REGISTRY}/proxy/node:20-alpine
  needs:
    - job: test:frontend
      optional: true
  <<: *node_cache
  script:
    - cd frontend
    - npm ci --prefer-offline --no-audit
    - npm run build
  artifacts:
    paths:
      - frontend/.next/
    expire_in: 1 hour
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH'
  timeout: 15 minutes

build:backend:
  stage: build
  image: ${HARBOR_REGISTRY}/proxy/python:3.12-slim
  needs:
    - job: test:backend
      optional: true
  <<: *pip_cache
  script:
    - cd backend
    - pip install --quiet -r requirements.txt
    - python -c "import sys; print(f'Python {sys.version}')"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH'
  timeout: 10 minutes

# =============================================================================
# Stage: Docker Build + Push
# =============================================================================

docker:frontend:
  extends: .docker-build
  needs:
    - job: build:frontend
      optional: true
    - job: test:frontend
      optional: true
  script:
    - |
      VERSION=${CI_COMMIT_SHORT_SHA}
      echo "Building frontend:$VERSION"
      docker build \
        -t $FRONTEND_IMAGE:$CI_COMMIT_SHORT_SHA \
        -t $FRONTEND_IMAGE:$CI_COMMIT_REF_SLUG \
        -t $FRONTEND_IMAGE:latest \
        -f frontend/Dockerfile \
        ./frontend
      docker push $FRONTEND_IMAGE:$CI_COMMIT_SHORT_SHA
      docker push $FRONTEND_IMAGE:$CI_COMMIT_REF_SLUG
      docker push $FRONTEND_IMAGE:latest
      echo "✅ Frontend pushed"

docker:backend:
  extends: .docker-build
  needs:
    - job: build:backend
      optional: true
    - job: test:backend
      optional: true
  script:
    - |
      VERSION=${CI_COMMIT_SHORT_SHA}
      echo "Building backend:$VERSION"
      docker build \
        -t $BACKEND_IMAGE:$CI_COMMIT_SHORT_SHA \
        -t $BACKEND_IMAGE:$CI_COMMIT_REF_SLUG \
        -t $BACKEND_IMAGE:latest \
        -f backend/Dockerfile \
        ./backend
      docker push $BACKEND_IMAGE:$CI_COMMIT_SHORT_SHA
      docker push $BACKEND_IMAGE:$CI_COMMIT_REF_SLUG
      docker push $BACKEND_IMAGE:latest
      echo "✅ Backend pushed"

# =============================================================================
# Workflow Rules
# =============================================================================

workflow:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS'
      when: never
    - if: '$CI_COMMIT_BRANCH'
