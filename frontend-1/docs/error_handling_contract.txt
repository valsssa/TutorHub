
# Error Handling Contract

This document defines the standard error formats, categorization, and UI behaviors expected by the frontend application when communicating with the backend.

## 1. Standard Error Format

All API error responses **must** follow this JSON structure. This allows the frontend to consistently parse and display errors without custom logic for every endpoint.

```json
{
  "error": {
    "code": "ERROR_CODE_STRING",
    "message": "Human-readable message safe for UI display.",
    "details": {
      "field_name": "Specific validation error message",
      "another_field": "Another error"
    },
    "traceId": "req-12345" // Optional, for debugging
  }
}
```

---

## 2. Error Categories & HTTP Status Codes

### **A. Validation Errors (400 Bad Request / 422 Unprocessable Entity)**
*   **Definition:** The request was malformed, missing required fields, or contained invalid data logic (e.g., "End time cannot be before start time").
*   **UI Behavior:**
    *   **Inline:** If `details` object is present, map errors to specific form fields (e.g., highlighting the "Email" input in red).
    *   **Toast:** If no `details` are provided, display the `message` in a global toast notification.
*   **Retry Logic:** **No Retry**. User must fix input.

### **B. Authentication & Authorization (401 Unauthorized / 403 Forbidden)**
*   **Definition:**
    *   **401:** Token is missing, invalid, or expired.
    *   **403:** User is authenticated but lacks permission (e.g., Student trying to access Admin dashboard).
*   **UI Behavior:**
    *   **401:** Trigger "Refresh Token" flow. If that fails, redirect to `/login`.
    *   **403:** Display a "Permission Denied" page or toast.
*   **Retry Logic:**
    *   **401:** Retry the original request **once** after successfully refreshing the token.

### **C. Resource Errors (404 Not Found)**
*   **Definition:** The requested entity (Tutor, Session) does not exist.
*   **UI Behavior:**
    *   **Page Load:** Show a "404 Not Found" component.
    *   **Action:** Show a toast (e.g., "This session has been cancelled").
*   **Retry Logic:** **No Retry**.

### **D. System & Server Errors (500, 502, 503, 504)**
*   **Definition:** Something went wrong on the backend (Database down, timeout, unhandled exception).
*   **UI Behavior:**
    *   Display a generic "Something went wrong, please try again later" toast.
    *   Log the error to client-side monitoring (e.g., Sentry).
*   **Retry Logic:**
    *   **GET Requests:** Retry **3 times** with exponential backoff.
    *   **POST/PUT/DELETE:** **No automatic retry** to prevent data duplication (unless Idempotency Keys are implemented).

---

## 3. UI Error Handling Strategies

### **User-Visible Errors**
These are errors the user needs to know about to proceed.
1.  **Form Validation:** "Password is too short."
2.  **Business Logic:** "This time slot is no longer available."
3.  **Payment Failures:** "Card declined."
4.  **Connectivity:** "You are offline."

### **Silent Errors**
These errors occur in the background and should **not** interrupt the user experience.
1.  **Analytics:** Failure to send a tracking event.
2.  **Prefetching:** Failure to pre-load the next page of results (just load normally when requested).
3.  **Non-Critical Metadata:** Failure to load a user's avatar (show fallback initial).

---

## 4. Specific Error Codes (Examples)

The `error.code` string allows the frontend to handle specific scenarios programmatically (e.g., showing a specific modal).

| Error Code | HTTP Status | Meaning | Frontend Action |
| :--- | :--- | :--- | :--- |
| `VALIDATION_ERROR` | 400 | Generic form error | Show inline errors. |
| `INVALID_CREDENTIALS` | 401 | Login failed | Show "Invalid email or password" on login form. |
| `TOKEN_EXPIRED` | 401 | JWT expired | Attempt refresh flow. |
| `SLOT_TAKEN` | 409 | Booking conflict | Refresh availability grid and ask user to pick another time. |
| `INSUFFICIENT_FUNDS` | 402 | Payment failed | Open "Top Up Wallet" modal. |
| `USER_NOT_VERIFIED` | 403 | Tutor action blocked | Redirect to Verification Manager. |
| `RATE_LIMIT_EXCEEDED` | 429 | Too many requests | Show "Please wait X seconds" and disable buttons. |

---

## 5. Retry Rules Summary

1.  **Idempotent Reads (GET):**
    *   Max Retries: 3
    *   Backoff: 1s, 2s, 4s
    *   Condition: 5xx errors or Network Error.

2.  **Mutations (POST/PUT/PATCH/DELETE):**
    *   Max Retries: 0 (Default)
    *   *Exception:* If `Idempotency-Key` header is supported by backend, treat like GET.

3.  **Authentication (401):**
    *   Max Retries: 1 (After token refresh).
