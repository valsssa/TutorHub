FROM node:20-alpine

WORKDIR /app

# Install required system dependencies for SWC
RUN apk add --no-cache python3 make g++

# Use official npm registry for reliable package installation
RUN npm config set registry https://registry.npmjs.org/

# Install dependencies (without package-lock to avoid corruption issues)
COPY package.json ./
RUN rm -f package-lock.json && npm install --no-package-lock

# Explicitly install SWC binaries for Alpine Linux from official registry
RUN npm install --save-optional --no-save @next/swc-linux-x64-musl || echo "SWC install attempted"

# Copy application
COPY . .

# Default command (can be overridden by docker-compose)
CMD ["npm", "test", "--", "--watchAll=false"]
